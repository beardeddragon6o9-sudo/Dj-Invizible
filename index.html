<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DJ INVIZIBLE — Interactive AI Mascot</title>
  <link rel="stylesheet" href="assets/css/style.css" />
</head>

<!-- Start on Invizible's theme; JS will toggle .theme-maverick when clicked -->
<body class="ai-only theme-invizible">
  <!-- Venue: stage background, lights, fog, crowd -->
  <div class="venue" aria-hidden="true">
    <div class="lights">
      <div class="beam left"></div>
      <div class="beam right"></div>
      <div class="beam center"></div>
    </div>
    <div class="fog"></div>
    <div class="crowd"></div>
  </div>

  <!-- Masthead: two mascots (Invizible primary, Maverick tucked behind) -->
  <div class="masthead">
    <div class="deck">
      <div class="disc left"></div>
      <div class="disc right"></div>
      <div class="stage-platform"></div>
    </div>

    <!-- DJ Invizible (starts as primary/center) -->
<button id="mascot-invizible" class="mascot primary" aria-label="DJ Invizible">
  <img src="assets/img/invizible.png" alt="DJ Invizible Mascot" class="mascot-img">
</button>

<!-- Midnight Maverick (starts tucked top-right) -->
<button id="mascot-maverick" class="mascot secondary" aria-label="Midnight Maverick">
  <img src="assets/img/maverick.png" alt="Midnight Maverick Mascot" class="mascot-img">
  <span class="summon-label">Summon Maverick</span>
</button>


  <div id="app">
    <!-- Chat/Command panel -->
    <div id="panel" class="hidden" aria-live="polite">
      <div id="panel-header">
        <span id="panel-title">DJ INVIZIBLE</span>
        <button id="close-panel" aria-label="Close panel">✕</button>
      </div>
      <div id="messages"></div>
      <form id="composer">
        <input id="input" type="text" placeholder="Talk to me… try: mixes, shows, book, about, contact" autocomplete="off" />
        <button type="submit" id="send">Send</button>
        <input type="hidden" id="booking-persona" name="persona" value="invizible" />
      </form>
    </div>

    <!-- Sections (hidden in AI-only mode for now) -->
    <main id="stage">
      <section id="hero" class="card center">
        <h1>DJ INVIZIBLE</h1>
        <p class="muted">An interactive site guided by an AI mascot. Ask about mixes, shows, booking & more.</p>
      </section>
      <section id="mixes" class="card"><h2>Mixes</h2></section>
      <section id="shows" class="card"><h2>Upcoming Shows</h2></section>
      <section id="book" class="card"><h2>Book Me</h2></section>
      <section id="about" class="card"><h2>About</h2></section>
      <section id="contact" class="card"><h2>Contact</h2></section>
    </main>
  </div>

  <script src="assets/js/script.js" defer></script>
</body>
</html>
<div id="log" style="max-height:24rem;overflow:auto;border:1px solid #ccc;padding:.75rem;border-radius:.5rem;"></div>
<form id="chat-form" style="margin-top:.5rem;display:flex;gap:.5rem;">
  <input id="chat-input" placeholder="Type a message…" style="flex:1;padding:.5rem;border:1px solid #ccc;border-radius:.5rem;" />
  <button style="padding:.5rem 1rem;">Send</button>
</form>

<script type="module">
const log = document.getElementById('log');
const form = document.getElementById('chat-form');
const inp = document.getElementById('chat-input');
const history = []; // [{ role: "user"|"assistant", content: "..." }]

function addBubble(role, text) {
  const div = document.createElement('div');
  div.style.margin = '6px 0';
  div.style.textAlign = role === 'user' ? 'right' : 'left';
  const bubble = document.createElement('span');
  bubble.textContent = text;
  bubble.style.display = 'inline-block';
  bubble.style.padding = '6px 10px';
  bubble.style.borderRadius = '12px';
  bubble.style.background = role === 'user' ? '#eee' : '#e6f0ff';
  div.appendChild(bubble);
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

async function askStream(messages, { system } = {}, onDelta) {
  const r = await fetch('/api/chat/stream', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ messages, system }),
  });
  const reader = r.body.getReader();
  const dec = new TextDecoder();
  let full = '';
  for (;;) {
    const { value, done } = await reader.read();
    if (done) break;
    const chunk = dec.decode(value, { stream: true });
    for (const line of chunk.split('\n')) {
      if (!line.startsWith('data:')) continue;
      const payload = JSON.parse(line.slice(5).trim());
      if (payload.delta) { full += payload.delta; onDelta?.(payload.delta, full); }
      if (payload.done) return full;
      if (payload.error) throw new Error(payload.error);
    }
  }
  return full;
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const text = inp.value.trim();
  if (!text) return;

  // user bubble
  addBubble('user', text);
  history.push({ role: 'user', content: text });
  inp.value = '';

  // assistant bubble that updates as it streams
  const live = document.createElement('div');
  live.style.margin = '6px 0';
  live.style.textAlign = 'left';
  const bubble = document.createElement('span');
  bubble.textContent = '';
  bubble.style.display = 'inline-block';
  bubble.style.padding = '6px 10px';
  bubble.style.borderRadius = '12px';
  bubble.style.background = '#e6f0ff';
  live.appendChild(bubble);
  log.appendChild(live);
  log.scrollTop = log.scrollHeight;

  try {
    const full = await askStream(history, { system: 'Be a helpful DJ assistant' },
      (_delta, whole) => { bubble.textContent = whole; log.scrollTop = log.scrollHeight; }
    );
    history.push({ role: 'assistant', content: full });
  } catch (err) {
    bubble.textContent = '(error: ' + (err.message || 'server_error') + ')';
    console.error(err);
  }
});
</script>
<!-- Chat UI -->
<section style="max-width: 40rem; margin: 1rem auto;">
  <div id="chat-log" style="max-height: 24rem; overflow: auto; border: 1px solid #ccc; padding: .75rem; border-radius: .5rem; background: #fff;"></div>
  <form id="chat-form" style="margin-top:.5rem; display:flex; gap:.5rem;">
    <input id="chat-input" placeholder="Type a message…" style="flex:1; padding:.5rem; border:1px solid #ccc; border-radius:.5rem;" />
    <button style="padding:.5rem 1rem;">Send</button>
  </form>
</section>

<!-- Load the streaming client -->
<script type="module" src="/assets/chat.js"></script>
